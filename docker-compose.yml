version: '2'

services:
    eve:
        build: ./eve/build
        networks:
            default:
        stdin_open: true
        tty: true
        volumes:
            - ./eve/config:/config
        privileged: true

    openvpn-spoof:
        extends:
            file: openvpn-compose.yml
            service: openvpn
        volumes:
            - ./openvpn/config/arp_spoof:/etc/openvpn
        networks:
            default:
            internal:
        ports:
            - "1194:1194/udp"
        environment:
            - NAUM_FILES=[arp_spoof/docker-compose.yml, common/docker-compose.yml]

    openvpn-shout:
        extends:
            file: openvpn-compose.yml
            service: openvpn
        volumes:
            - ./openvpn/config/shout:/etc/openvpn
        networks:
            default:
            internal:
        ports:
            - "1195:1195/udp"
        environment:
            - NAUM_FILES=[listen/docker-compose.yml, common/docker-compose.yml]

    redis:
        image: "redis:alpine"
        networks:
            internal:
                aliases:
                    - "$REDIS_HOSTNAME"
        volumes:
            - ./redis/config:/usr/local/etc/redis
        command: [redis-server, /usr/local/etc/redis/redis.conf]

    cluster-manager:
        build: ./cluster-manager/build
        depends_on:
            - redis
        networks: 
            internal:
        volumes:
            - ./cluster-manager/app:/app
            - ./challenges:/challenges
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/run/docker/netns/default:/var/run/netns/host
        command: [python3, /app/cluster-manager.py]
        environment:
            - REDIS_HOSTNAME
            - REDIS_PORT
            - REDIS_DB
            - REDIS_PASSWORD
        privileged: true
        restart: always


networks:
    internal:
        internal: true
